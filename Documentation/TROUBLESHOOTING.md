# Troubleshooting Guide –¥–ª—è Alma-Bitrix24 Integration

## üö® –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏—è

### 1. –û—à–∏–±–∫–∞ "It is not possible to rent a unit divided into rooms"

**–ü—Ä–∏—á–∏–Ω–∞:** –°–∏—Å—Ç–µ–º–∞ –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–∞ —é–Ω–∏—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–∑–¥–µ–ª–µ–Ω –Ω–∞ –∫–æ–º–Ω–∞—Ç—ã –≤ Alma.

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç –≤ Bitrix24
curl -X POST "https://colifeae.bitrix24.eu/rest/86428/veqe4foxak36hydi/crm.item.get" \
     -H "Content-Type: application/x-www-form-urlencoded" \
     -d "entityTypeId=183&id=CONTRACT_ID"

# –ù–∞–π—Ç–∏ –ø–æ–ª–µ ufCrm20_1693919019 - —ç—Ç–æ ID –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ –≤ Bitrix24
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∫–∞–∫–æ–π –æ–±—ä–µ–∫—Ç –≤ Alma –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —ç—Ç–æ–º—É external_id
curl -X GET "https://colife.argo.properties:1337/external_api/realty/rental_object/EXTERNAL_ID/" \
     -H "Api-Key: 3ae0539d134e9b7320e6d3ff28a11bde"
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –ù–∞–π—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –≤ Alma (–Ω–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–π –Ω–∞ –∫–æ–º–Ω–∞—Ç—ã)
2. –û—Å–≤–æ–±–æ–¥–∏—Ç—å external_id –æ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
3. –ü—Ä–∏–≤—è–∑–∞—Ç—å external_id –∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –æ–±—ä–µ–∫—Ç—É

```bash
# –û—Å–≤–æ–±–æ–¥–∏—Ç—å external_id –æ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
curl -X PATCH "https://colife.argo.properties:1337/external_api/realty/units/WRONG_UNIT_ID/" \
     -H "Api-Key: 3ae0539d134e9b7320e6d3ff28a11bde" \
     -H "Content-Type: application/json" \
     -d '{"external_id": "OLD_ID_temp"}'

# –ü—Ä–∏–≤—è–∑–∞—Ç—å external_id –∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –æ–±—ä–µ–∫—Ç—É
curl -X PATCH "https://colife.argo.properties:1337/external_api/realty/units/CORRECT_UNIT_ID/" \
     -H "Api-Key: 3ae0539d134e9b7320e6d3ff28a11bde" \
     -H "Content-Type: application/json" \
     -d '{"external_id": "EXTERNAL_ID"}'
```

### 2. –û—à–∏–±–∫–∞ "Cannot create contract on archived unit"

**–ü—Ä–∏—á–∏–Ω–∞:** –û–±—ä–µ–∫—Ç –∑–∞–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ Alma.

**–†–µ—à–µ–Ω–∏–µ:** –†–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ Alma –∏–ª–∏ —á–µ—Ä–µ–∑ API:
```bash
curl -X PATCH "https://colife.argo.properties:1337/external_api/realty/units/UNIT_ID/archive/" \
     -H "Api-Key: 3ae0539d134e9b7320e6d3ff28a11bde" \
     -H "Content-Type: application/json" \
     -d '{"is_archived": false}'
```

### 3. External ID –º–∞–ø–ø–∏–Ω–≥ –ø—Ä–æ–±–ª–µ–º—ã

**–í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å:**
- –í Bitrix24 –ø–æ–ª–µ `ufCrm20_1693919019` —Å–æ–¥–µ—Ä–∂–∏—Ç **–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ –∏–∑ Bitrix24**
- –≠—Ç–æ—Ç ID –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ `external_id` –≤ Alma
- –°–∏—Å—Ç–µ–º–∞ –∏—â–µ—Ç –æ–±—ä–µ–∫—Ç –≤ Alma —á–µ—Ä–µ–∑ `/external_api/realty/rental_object/EXTERNAL_ID/`

**–ü—Ä–æ—Ü–µ—Å—Å –ø–æ–∏—Å–∫–∞ –æ–±—ä–µ–∫—Ç–∞:**
1. –ö–æ–Ω—Ç—Ä–∞–∫—Ç ‚Üí `ufCrm20_1693919019` (ID –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ –≤ Bitrix24)
2. –°–∏—Å—Ç–µ–º–∞ –∏—â–µ—Ç –≤ Alma –æ–±—ä–µ–∫—Ç —Å `external_id = ID –∏–∑ Bitrix24`
3. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–≥–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞

**–ß–∞—Å—Ç–∞—è –æ—à–∏–±–∫–∞:** External_id –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –æ–±—ä–µ–∫—Ç—É –≤ Alma.

## üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç –≤ Bitrix24:
```bash
curl -X POST "https://colifeae.bitrix24.eu/rest/86428/veqe4foxak36hydi/crm.item.get" \
     -H "Content-Type: application/x-www-form-urlencoded" \
     -d "entityTypeId=183&id=CONTRACT_ID" | jq '.result.item.ufCrm20_1693919019'
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—ä–µ–∫—Ç –≤ Alma –ø–æ external_id:
```bash
curl -X GET "https://colife.argo.properties:1337/external_api/realty/rental_object/EXTERNAL_ID/" \
     -H "Api-Key: 3ae0539d134e9b7320e6d3ff28a11bde"
```

### –ù–∞–π—Ç–∏ –æ–±—ä–µ–∫—Ç—ã —Å –ø–æ—Ö–æ–∂–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º:
```bash
curl -X GET "https://colife.argo.properties:1337/external_api/realty/units/" \
     -H "Api-Key: 3ae0539d134e9b7320e6d3ff28a11bde" | \
     jq '.[] | select(.name | contains("SEARCH_TERM")) | {id, name, external_id}'
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –æ–±—ä–µ–∫—Ç–∞:
```bash
curl -X GET "https://colife.argo.properties:1337/external_api/realty/units/UNIT_ID/" \
     -H "Api-Key: 3ae0539d134e9b7320e6d3ff28a11bde" | \
     jq '{id, name, external_id, is_archived, status}'
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é:
```bash
curl -X GET "https://alma.colifeb24apps.ru/tenatContract.php?id=CONTRACT_ID"
```

## üìã –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞–º–∏

1. ‚úÖ –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –∏–∑ Bitrix24
2. ‚úÖ –ù–∞–π—Ç–∏ –ø–æ–ª–µ `ufCrm20_1693919019` (ID –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞)
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∫–∞–∫–æ–π –æ–±—ä–µ–∫—Ç –≤ Alma –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —ç—Ç–æ–º—É external_id
4. ‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–±—ä–µ–∫—Ç –Ω–µ –∑–∞–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω
5. ‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–±—ä–µ–∫—Ç –Ω–µ —Ä–∞–∑–¥–µ–ª–µ–Ω –Ω–∞ –∫–æ–º–Ω–∞—Ç—ã
6. ‚úÖ –ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π - –Ω–∞–π—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏ –ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∏—Ç—å external_id
7. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é

## üéØ –ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

- `UF_CRM_20_1693919019` - **Apartments** (ID –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ –≤ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞—Ö)
- `UF_CRM_20_CONTRACT_START_DATE` - –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –∞—Ä–µ–Ω–¥—ã
- `UF_CRM_20_CONTRACT_END_DATE` - –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã
- `OPPORTUNITY_WITH_CURRENCY` - —Å—É–º–º–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞

## ‚ö†Ô∏è –ù–ï –î–ï–õ–ê–¢–¨

- –ù–ï –≤—ã–¥—É–º—ã–≤–∞—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `parentId167`)
- –ù–ï –ø—ã—Ç–∞—Ç—å—Å—è –æ–±–Ω–æ–≤–ª—è—Ç—å –ø–æ–ª—è —á–µ—Ä–µ–∑ API, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
- –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã –Ω–∞ –∑–∞–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–ª–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–µ –Ω–∞ –∫–æ–º–Ω–∞—Ç—ã –æ–±—ä–µ–∫—Ç—ã

## üîç –û–¢–ö–†–´–¢–´–ï –í–û–ü–†–û–°–´ –ò –ü–†–û–ë–õ–ï–ú–´

### ‚ùì –ü—Ä–æ–±–ª–µ–º–∞ —Å –¥–∞—Ç–∞–º–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤
**–ù–∞–π–¥–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞:** –°–∏—Å—Ç–µ–º–∞ —á–∏—Ç–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–∞—Ç –≤ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞—Ö.

**–ö–æ–Ω—Ç—Ä–∞–∫—Ç 6026 (–ø—Ä–∏–º–µ—Ä):**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: `ufCrm20ContractStartDate: "2025-03-08"` (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: `ufCrm_20_CONTRACT_START_DATE_2: "2025-09-08"` (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)

**–í–æ–∑–º–æ–∂–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–¥ —á—Ç–æ–±—ã —á–∏—Ç–∞—Ç—å –∏–∑ –ø–æ–ª–µ–π `_2`:
```php
'UF_CRM_20_CONTRACT_START_DATE' => $bitrixData['ufCrm_20_CONTRACT_START_DATE_2'] ?? $bitrixData['ufCrm20ContractStartDate'] ?? '',
'UF_CRM_20_CONTRACT_END_DATE' => $bitrixData['ufCrm_20_CONTRACT_END_DATE_2'] ?? $bitrixData['ufCrm20ContractEndDate'] ?? '',
```

**–°—Ç–∞—Ç—É—Å:** –¢—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è


## üîÑ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

**Bitrix24 ‚Üí Alma –º–∞–ø–ø–∏–Ω–≥:**
- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ –≤ Bitrix24 ‚Üí external_id –≤ Alma
- –°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç rental_object API –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
- –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ tenant_contracts API

**–ò–µ—Ä–∞—Ä—Ö–∏—è –≤ Alma:**
- –ü—Ä–æ–µ–∫—Ç—ã ‚Üí –ó–¥–∞–Ω–∏—è ‚Üí –ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã ‚Üí –ö–æ–º–Ω–∞—Ç—ã
- –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –Ω–∞ –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã –∏–ª–∏ –∫–æ–º–Ω–∞—Ç—ã, –Ω–æ –ù–ï –Ω–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–µ –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã
